#!/usr/bin/env bash
# Configure Nginx to run as nginx user on port 8080

# Create nginx user if it doesn't exist
id -u nginx &>/dev/null || useradd -r -s /bin/false nginx

# Remove user directive from nginx.conf (not needed when running as nginx)
sed -i 's/^user /#user /' /etc/nginx/nginx.conf

# Create a clean default config for port 8080
cat > /etc/nginx/sites-available/default << 'NGINX_DEFAULT'
server {
    listen 8080 default_server;
    listen [::]:8080 default_server;
    
    root /var/www/html;
    index index.html index.htm;
    
    server_name _;
    
    location / {
        try_files $uri $uri/ =404;
    }
}
NGINX_DEFAULT

cp /etc/nginx/sites-available/default /etc/nginx/sites-enabled/default

# Fix permissions for nginx user
chown -R nginx:nginx /var/log/nginx /var/lib/nginx /etc/nginx
mkdir -p /run/nginx
chown -R nginx:nginx /run/nginx

# Update PID location
sed -i '/^pid/d' /etc/nginx/nginx.conf
sed -i '1i pid /run/nginx/nginx.pid;' /etc/nginx/nginx.conf

# Stop any running nginx
service nginx stop 2>/dev/null || killall nginx 2>/dev/null || true

# Start nginx as nginx user
sudo -u nginx /usr/sbin/nginx
